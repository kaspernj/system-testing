before_install:
  - sudo apt-get update && sudo apt-get install -y ca-certificates openjdk-17-jdk wget
  - if [ ! -x /usr/bin/node ]; then sudo ln -sf "$(command -v node)" /usr/bin/node; fi
  - wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
  - sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
  - rm -f google-chrome-stable_current_amd64.deb
before_script:
  - npm install
  - cd spec/dummy && npm install
mem_limit: 16384m
builds:
  build_1:
    name: Default checks
    script:
      - SYSTEM_TEST_DRIVER=selenium SYSTEM_TEST_APPIUM_DRIVERS= SYSTEM_TEST_APPIUM_CAPABILITIES= SYSTEM_TEST_APPIUM_SERVER_ARGS= npm run all-checks
  build_2:
    name: Appium Web (Chrome)
    environment:
      SYSTEM_TEST_HOST: dist
      SYSTEM_TEST_DRIVER: appium
      SYSTEM_TEST_APPIUM_DRIVERS: chromium
      SYSTEM_TEST_APPIUM_TEST_ID_STRATEGY: css
      SYSTEM_TEST_APPIUM_CAPABILITIES: '{"platformName":"linux","browserName":"chrome","appium:automationName":"Chromium","appium:autodownloadEnabled":true,"goog:chromeOptions":{"binary":"/usr/bin/google-chrome","args":["--headless=new","--no-sandbox","--disable-dev-shm-usage","--disable-gpu"]}}'
    script:
      - npx appium driver update chromium || npx appium driver install chromium
      - npx node node_modules/appium-chromium-driver/scripts/install-chromedriver.mjs
      - npm run test:appium:web
  build_3:
    name: Appium Android
    devices:
      - /dev/kvm:/dev/kvm
    environment:
      ANDROID_SDK_ROOT: /tmp/android-sdk
      ANDROID_HOME: /tmp/android-sdk
      ANDROID_SDK_HOME: /tmp/android-sdk-home
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      PATH: /usr/lib/jvm/java-17-openjdk-amd64/bin:$PATH
      GRADLE_USER_HOME: /tmp/gradle-home
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2 -Dorg.gradle.jvmargs=-Xmx3g -Dkotlin.daemon.jvm.options=-Xmx2g"
      ANDROID_GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2 -Dorg.gradle.jvmargs=-Xmx3g -Dkotlin.daemon.jvm.options=-Xmx2g"
      SYSTEM_TEST_HTTP_CONNECT_HOST: 10.0.2.2
      SYSTEM_TEST_HOST: dist
      SYSTEM_TEST_DRIVER: appium
      SYSTEM_TEST_APPIUM_DRIVERS: uiautomator2
      SYSTEM_TEST_APPIUM_TEST_ID_STRATEGY: css
      SYSTEM_TEST_APPIUM_SERVER_ARGS: '{"allowInsecure":["uiautomator2:chromedriver_autodownload"]}'
      SYSTEM_TEST_APPIUM_CAPABILITIES: '{"platformName":"Android","appium:automationName":"UiAutomator2","appium:deviceName":"Android Emulator","browserName":"Chrome","appium:chromedriverAutodownload":true}'
    script:
      - ANDROID_EMULATOR_STAGE=install ANDROID_NDK_VERSION=27.1.12297006 ANDROID_SDK_PACKAGES="build-tools;36.0.0,platforms;android-36,cmake;3.22.1" node scripts/setup-android-emulator.js
      - ANDROID_EMULATOR_STAGE=start node scripts/setup-android-emulator.js
      - cd spec/dummy && EXPO_PUBLIC_SYSTEM_TEST=true EXPO_PUBLIC_SYSTEM_TEST_HOST=10.0.2.2 npx expo prebuild --platform android --no-install --non-interactive
      - cd spec/dummy/android && echo "sdk.dir=/tmp/android-sdk" > local.properties
      - cd spec/dummy/android && ANDROID_SDK_ROOT=/tmp/android-sdk ANDROID_HOME=/tmp/android-sdk ANDROID_SDK_HOME=/tmp/android-sdk-home GRADLE_USER_HOME=/tmp/gradle-home ./gradlew --no-daemon --stacktrace assembleDebug
      - npx appium driver update uiautomator2 || npx appium driver install uiautomator2
      - npm test
