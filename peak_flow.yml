before_script:
  - npm install
  - cd spec/dummy && npm install
builds:
  build_1:
    name: Default checks
    script:
      - npm run all-checks
  build_2:
    name: Appium Web (Chrome)
    environment:
      SYSTEM_TEST_HOST: dist
      SYSTEM_TEST_DRIVER: appium
      SYSTEM_TEST_APPIUM_DRIVERS: chromium
      SYSTEM_TEST_APPIUM_TEST_ID_STRATEGY: css
      SYSTEM_TEST_APPIUM_SERVER_ARGS: '{"allowInsecure":["chromium:chromedriver_autodownload"]}'
      SYSTEM_TEST_APPIUM_CAPABILITIES: '{"platformName":"Linux","browserName":"Chrome","appium:automationName":"Chromium","appium:chromedriverAutodownload":true}'
    script:
      - npm run export:web
      - npx appium driver update chromium || npx appium driver install chromium
      - npm test
  build_3:
    name: Appium Android
    devices:
      - /dev/kvm:/dev/kvm
    environment:
      ANDROID_SDK_ROOT: /tmp/android-sdk
      ANDROID_HOME: /tmp/android-sdk
      ANDROID_SDK_HOME: /tmp/android-sdk-home
      GRADLE_USER_HOME: /tmp/gradle-home
      SYSTEM_TEST_HTTP_CONNECT_HOST: 10.0.2.2
      SYSTEM_TEST_HOST: dist
      SYSTEM_TEST_DRIVER: appium
      SYSTEM_TEST_APPIUM_DRIVERS: uiautomator2
      SYSTEM_TEST_APPIUM_TEST_ID_STRATEGY: css
      SYSTEM_TEST_APPIUM_SERVER_ARGS: '{"allowInsecure":["uiautomator2:chromedriver_autodownload"]}'
      SYSTEM_TEST_APPIUM_CAPABILITIES: '{"platformName":"Android","appium:automationName":"UiAutomator2","appium:deviceName":"Android Emulator","browserName":"Chrome","appium:chromedriverAutodownload":true}'
    script:
      - sudo apt-get update
      - sudo apt-get install -y default-jdk
      - ANDROID_EMULATOR_STAGE=install ANDROID_NDK_VERSION=27.1.12297006 ANDROID_SDK_PACKAGES="build-tools;36.0.0,platforms;android-36,cmake;3.22.1" node scripts/setup-android-emulator.js
      - ANDROID_EMULATOR_STAGE=start node scripts/setup-android-emulator.js
      - cd spec/dummy && EXPO_PUBLIC_SYSTEM_TEST=true EXPO_PUBLIC_SYSTEM_TEST_HOST=10.0.2.2 npx expo prebuild --platform android --no-install --non-interactive
      - cd spec/dummy/android && echo "sdk.dir=/tmp/android-sdk" > local.properties
      - cd spec/dummy/android && ANDROID_SDK_ROOT=/tmp/android-sdk ANDROID_HOME=/tmp/android-sdk ANDROID_SDK_HOME=/tmp/android-sdk-home GRADLE_USER_HOME=/tmp/gradle-home ./gradlew assembleDebug
      - cd /home/build/project
      - npx appium driver update uiautomator2 || npx appium driver install uiautomator2
      - npm test
